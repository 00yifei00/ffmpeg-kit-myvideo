name: Build FFmpegKit AAR

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-android-aar:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r27c
          link-to-sdk: true

      - name: Export NDK path
        run: echo "ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y git build-essential yasm pkg-config

      - name: Build FFmpegKit AAR
        run:
          bash android.sh \
              --enable-libmp3lame \     # 启用 MP3 编码
              --enable-demuxer=matroska,mov \  # 启用 MKV 和 MP4 解封装
              --enable-decoder=subrip,ass \    # 启用字幕解码
              --disable-arm-v7a \       # 按需禁用不支持的架构
              --disable-x86
        
      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-kit-myvideo-aar
          path: ffmpeg-kit-myvideo/prebuilt/bundle-android-aar/*.aar